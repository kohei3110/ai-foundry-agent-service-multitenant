name: Deploy Pooled Application

on:
  push:
    paths:
      - 'pooled/app/**'
  pull_request:
    paths:
      - 'pooled/app/**'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - staging
          - prod
      force_deploy:
        description: 'Force deployment even if no changes detected'
        required: false
        default: false
        type: boolean

env:
  AZURE_CLIENT_ID: ${{ vars.AZURE_CLIENT_ID }}
  AZURE_TENANT_ID: ${{ vars.AZURE_TENANT_ID }}
  AZURE_SUBSCRIPTION_ID: ${{ vars.AZURE_SUBSCRIPTION_ID }}
  IMAGE_NAME: fas-pooled-app

permissions:
  id-token: write
  contents: read
  packages: write

jobs:
  detect-environment:
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.set-env.outputs.environment }}
      should_deploy: ${{ steps.check-changes.outputs.should_deploy }}
      image_tag: ${{ steps.set-tag.outputs.image_tag }}
      registry_name: ${{ steps.set-registry.outputs.registry_name }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine environment
        id: set-env
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "environment=${{ github.event.inputs.environment }}" >> $GITHUB_OUTPUT
          elif [ "${{ github.ref }}" == "refs/heads/main" ]; then
            echo "environment=prod" >> $GITHUB_OUTPUT
          elif [ "${{ github.ref }}" == "refs/heads/develop" ]; then
            echo "environment=staging" >> $GITHUB_OUTPUT
          else
            echo "environment=dev" >> $GITHUB_OUTPUT
          fi

      - name: Set registry name
        id: set-registry
        run: |
          ENV="${{ steps.set-env.outputs.environment }}"
          # Azure Container RegistryÂêç„ÅØÂ∞èÊñáÂ≠ó„ÅÆ„Ç¢„É´„Éï„Ç°„Éô„ÉÉ„Éà„Å®Êï∞Â≠ó„ÅÆ„Åø„ÄÅ5-50ÊñáÂ≠ó
          REGISTRY_NAME="crfaspooled${ENV}"
          echo "registry_name=$REGISTRY_NAME" >> $GITHUB_OUTPUT
          echo "Registry name: $REGISTRY_NAME"

      - name: Set image tag
        id: set-tag
        run: |
          ENV="${{ steps.set-env.outputs.environment }}"
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            echo "image_tag=pr-${{ github.event.number }}-$(echo ${{ github.sha }} | cut -c1-8)" >> $GITHUB_OUTPUT
          else
            echo "image_tag=${ENV}-$(echo ${{ github.sha }} | cut -c1-8)" >> $GITHUB_OUTPUT
          fi

      - name: Check for application changes
        id: check-changes
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ] && [ "${{ github.event.inputs.force_deploy }}" == "true" ]; then
            echo "should_deploy=true" >> $GITHUB_OUTPUT
            echo "Force deployment requested"
          elif [ "${{ github.event_name }}" == "pull_request" ]; then
            echo "should_deploy=false" >> $GITHUB_OUTPUT
            echo "Pull request - build and test only"
          else
            # Check if there are changes in pooled/app directory
            if git diff --name-only HEAD~1 HEAD | grep -q "^pooled/app/"; then
              echo "should_deploy=true" >> $GITHUB_OUTPUT
              echo "Application changes detected"
            else
              echo "should_deploy=false" >> $GITHUB_OUTPUT
              echo "No application changes detected"
            fi
          fi

  test-application:
    runs-on: ubuntu-latest
    needs: detect-environment
    defaults:
      run:
        working-directory: ./pooled/app
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install uv
        uses: astral-sh/setup-uv@v3
        with:
          enable-cache: true

      - name: Install dependencies
        run: |
          uv sync --all-extras

      - name: Run linting
        run: |
          echo "Running code quality checks..."
          # Add your linting commands here if you have them configured
          # Example: uv run ruff check .
          # Example: uv run black --check .

      - name: Run tests
        run: |
          echo "Running unit tests..."
          uv run pytest tests/unit/ -v --cov=src --cov-report=xml --cov-report=html
        continue-on-error: true

      - name: Run integration tests
        run: |
          echo "Running integration tests..."
          uv run pytest tests/integration/ -v
        continue-on-error: true

      - name: Upload coverage reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-reports
          path: |
            pooled/app/coverage.xml
            pooled/app/htmlcov/
          retention-days: 7

  build-and-push-image:
    runs-on: ubuntu-latest
    needs: [detect-environment, test-application]
    outputs:
      image_uri: ${{ steps.build.outputs.image_uri }}
    defaults:
      run:
        working-directory: ./pooled/app
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Get ACR login server
        id: acr-login
        run: |
          REGISTRY_NAME="crfaspooleddeveastus2001dev"
          
          echo "Looking for registry: $REGISTRY_NAME"
          
          # Get ACR login server with better error handling
          if LOGIN_SERVER=$(az acr show --name "$REGISTRY_NAME" --query loginServer --output tsv 2>/dev/null); then
            echo "login_server=$LOGIN_SERVER" >> $GITHUB_OUTPUT
            echo "registry_name=$REGISTRY_NAME" >> $GITHUB_OUTPUT
            echo "‚úÖ Found ACR: $LOGIN_SERVER"
          else
            echo "‚ùå Azure Container Registry '$REGISTRY_NAME' not found"
            echo "Available registries in subscription:"
            az acr list --query "[].{Name:name,LoginServer:loginServer}" --output table || true
            echo "Make sure the infrastructure is deployed first"
            exit 1
          fi

      - name: Log in to Azure Container Registry
        run: |
          az acr login --name ${{ steps.acr-login.outputs.registry_name }}

      - name: Build and push Docker image
        id: build
        run: |
          IMAGE_TAG="${{ needs.detect-environment.outputs.image_tag }}"
          LOGIN_SERVER="${{ steps.acr-login.outputs.login_server }}"
          IMAGE_URI="${LOGIN_SERVER}/${{ env.IMAGE_NAME }}:${IMAGE_TAG}"
          
          echo "Building image: $IMAGE_URI"
          echo "Git SHA: ${{ github.sha }}"
          echo "Short SHA: $(echo ${{ github.sha }} | cut -c1-8)"
          
          # Build and push the image without cache
          docker buildx build \
            --platform linux/amd64 \
            --tag "$IMAGE_URI" \
            --push \
            --build-arg GIT_SHA="${{ github.sha }}" \
            --build-arg SHORT_SHA="$(echo ${{ github.sha }} | cut -c1-8)" \
            --metadata-file /tmp/metadata.json \
            .
          
          echo "image_uri=$IMAGE_URI" >> $GITHUB_OUTPUT
          echo "‚úÖ Image built and pushed successfully: $IMAGE_URI"
          
          # Output build metadata for debugging
          if [ -f /tmp/metadata.json ]; then
            echo "Build metadata:"
            cat /tmp/metadata.json
          fi

  deploy-application:
    runs-on: ubuntu-latest
    needs: [detect-environment, build-and-push-image]
    environment: 
      name: pooled-${{ needs.detect-environment.outputs.environment }}
      url: https://portal.azure.com/#@${{ env.AZURE_TENANT_ID }}/resource/subscriptions/${{ env.AZURE_SUBSCRIPTION_ID }}/resourceGroups/rg-fas-pooled-${{ needs.detect-environment.outputs.environment }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploy to Azure Container Apps
        run: |
          ENVIRONMENT="${{ needs.detect-environment.outputs.environment }}"
          RESOURCE_GROUP="rg-fasmultitenant-demo-eastus2-001"
          CONTAINER_APP_NAME="ca-fas-pooled-${ENVIRONMENT}"
          IMAGE_URI="${{ needs.build-and-push-image.outputs.image_uri }}"
          
          echo "üöÄ Deploying to environment: $ENVIRONMENT"
          echo "üì¶ Resource Group: $RESOURCE_GROUP"
          echo "üèóÔ∏è  Container App: $CONTAINER_APP_NAME"
          echo "üì∏ Image: $IMAGE_URI"
          
          # Validate resources exist before deployment
          if ! az group show --name "$RESOURCE_GROUP" --output none 2>/dev/null; then
            echo "‚ùå Resource Group '$RESOURCE_GROUP' not found"
            exit 1
          fi
          
          if ! az containerapp show --name "$CONTAINER_APP_NAME" --resource-group "$RESOURCE_GROUP" --output none 2>/dev/null; then
            echo "‚ùå Container App '$CONTAINER_APP_NAME' not found in resource group '$RESOURCE_GROUP'"
            echo "Available Container Apps:"
            az containerapp list --resource-group "$RESOURCE_GROUP" --query "[].name" --output table || true
            exit 1
          fi
          
          echo "‚úÖ Resources validated, starting deployment..."
          
          # Deploy with zero-downtime rolling update
          az containerapp update \
            --name "$CONTAINER_APP_NAME" \
            --resource-group "$RESOURCE_GROUP" \
            --image "$IMAGE_URI" \
            --set-env-vars \
              ENVIRONMENT="$ENVIRONMENT" \
              AZURE_CLIENT_ID="${{ env.AZURE_CLIENT_ID }}" \
              BUILD_NUMBER="${{ github.run_number }}" \
              COMMIT_SHA="${{ github.sha }}" \
              CONTAINER_APPS_SUBSCRIPTION_ID="${{ env.AZURE_SUBSCRIPTION_ID }}" \
              CONTAINER_APPS_RESOURCE_GROUP="$RESOURCE_GROUP" \
            --revision-suffix "$(date +%Y%m%d-%H%M%S)" \
            --output table
          
          echo "‚úÖ Deployment command completed"

      - name: Verify deployment
        run: |
          ENVIRONMENT="${{ needs.detect-environment.outputs.environment }}"
          RESOURCE_GROUP="rg-fasmultitenant-demo-eastus2-001"
          CONTAINER_APP_NAME="ca-fas-pooled-${ENVIRONMENT}"
          
          echo "üîç Verifying deployment..."
          
          # Wait for deployment to settle
          echo "‚è≥ Waiting for deployment to stabilize..."
          sleep 45
          
          # Get Container App FQDN
          FQDN=$(az containerapp show \
            --name "$CONTAINER_APP_NAME" \
            --resource-group "$RESOURCE_GROUP" \
            --query "properties.configuration.ingress.fqdn" \
            --output tsv)
          
          if [ -n "$FQDN" ] && [ "$FQDN" != "null" ]; then
            echo "‚úÖ Container App is running"
            echo "üåê Application URL: https://$FQDN"
            
            # Enhanced health check with retry logic
            echo "üè• Performing health check..."
            HEALTH_URL="https://$FQDN/health"
            MAX_RETRIES=6
            RETRY_COUNT=0
            
            while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
              if curl -f -s --connect-timeout 10 --max-time 30 "$HEALTH_URL" > /dev/null 2>&1; then
                echo "‚úÖ Health check passed on attempt $((RETRY_COUNT + 1))"
                break
              else
                RETRY_COUNT=$((RETRY_COUNT + 1))
                if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                  echo "‚è≥ Health check failed, retrying in 15 seconds (attempt $RETRY_COUNT/$MAX_RETRIES)..."
                  sleep 15
                else
                  echo "‚ö†Ô∏è Health check failed after $MAX_RETRIES attempts"
                  echo "The application may still be starting up. Please check manually."
                fi
              fi
            done
          else
            echo "‚ùå Failed to get Container App FQDN"
            exit 1
          fi

      - name: Get application logs
        if: failure()
        run: |
          ENVIRONMENT="${{ needs.detect-environment.outputs.environment }}"
          RESOURCE_GROUP="rg-fasmultitenant-demo-eastus2-001"
          CONTAINER_APP_NAME="ca-fas-pooled-${ENVIRONMENT}"
          
          echo "Getting application logs for troubleshooting..."
          az containerapp logs show \
            --name "$CONTAINER_APP_NAME" \
            --resource-group "$RESOURCE_GROUP" \
            --tail 50 || true

  post-deployment:
    runs-on: ubuntu-latest
    needs: [detect-environment, build-and-push-image, deploy-application]
    if: always() && (needs.build-and-push-image.result != 'skipped' || needs.deploy-application.result != 'skipped')
    steps:
      - name: Post-deployment summary
        run: |
          ENVIRONMENT="${{ needs.detect-environment.outputs.environment }}"
          IMAGE_TAG="${{ needs.detect-environment.outputs.image_tag }}"
          
          echo "## Application Deployment Summary üöÄ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: $ENVIRONMENT" >> $GITHUB_STEP_SUMMARY
          echo "- **Architecture**: Pooled Multi-Tenant" >> $GITHUB_STEP_SUMMARY
          echo "- **Image Tag**: $IMAGE_TAG" >> $GITHUB_STEP_SUMMARY
          echo "- **Build Status**: ${{ needs.build-and-push-image.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Deployment Status**: ${{ needs.deploy-application.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Image URI**: ${{ needs.build-and-push-image.outputs.image_uri }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Deployed by**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.deploy-application.result }}" == "success" ] || [ "${{ github.event_name }}" == "pull_request" ]; then
            if [ "${{ github.event_name }}" == "pull_request" ]; then
              echo "üîç **Pull Request Build Completed!**" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "- Docker image built and pushed successfully" >> $GITHUB_STEP_SUMMARY
              echo "- All tests passed" >> $GITHUB_STEP_SUMMARY
              echo "- Ready for deployment when merged" >> $GITHUB_STEP_SUMMARY
            else
              echo "üéâ **Deployment completed successfully!**" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
              echo "- Check the [Azure Portal](https://portal.azure.com/#@${{ env.AZURE_TENANT_ID }}/resource/subscriptions/${{ env.AZURE_SUBSCRIPTION_ID }}/resourceGroups/rg-fas-pooled-$ENVIRONMENT)" >> $GITHUB_STEP_SUMMARY
              echo "- Verify application health at the Container App URL" >> $GITHUB_STEP_SUMMARY
              echo "- Run end-to-end tests" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "‚ùå **Deployment failed!**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Please check the workflow logs and resolve any issues before retrying." >> $GITHUB_STEP_SUMMARY
          fi

      - name: Notify on failure
        if: failure()
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            echo "üö® Pooled application build failed for PR #${{ github.event.number }}"
          else
            echo "üö® Pooled application deployment failed for environment: ${{ needs.detect-environment.outputs.environment }}"
          fi
          echo "Please check the workflow logs for details."
