name: Deploy Silo Infrastructure

on:
  push:
    branches:
      - main
      - develop
    paths:
      - 'silo/infra/**'
  pull_request:
    branches:
      - main
    paths:
      - 'silo/infra/**'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - staging
          - prod
      tenant_id:
        description: 'Tenant ID for silo deployment'
        required: true
        default: 'contoso'
        type: string
      force_deploy:
        description: 'Force deployment even if no changes detected'
        required: false
        default: false
        type: boolean

permissions:
  id-token: write
  contents: read

jobs:
  detect-environment:
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.set-env.outputs.environment }}
      tenant_id: ${{ steps.set-env.outputs.tenant_id }}
      should_deploy: ${{ steps.check-changes.outputs.should_deploy }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine environment and tenant
        id: set-env
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "environment=${{ github.event.inputs.environment }}" >> $GITHUB_OUTPUT
            echo "tenant_id=${{ github.event.inputs.tenant_id }}" >> $GITHUB_OUTPUT
          elif [ "${{ github.ref }}" == "refs/heads/main" ]; then
            echo "environment=prod" >> $GITHUB_OUTPUT
            echo "tenant_id=contoso" >> $GITHUB_OUTPUT
          elif [ "${{ github.ref }}" == "refs/heads/develop" ]; then
            echo "environment=staging" >> $GITHUB_OUTPUT
            echo "tenant_id=contoso" >> $GITHUB_OUTPUT
          else
            echo "environment=dev" >> $GITHUB_OUTPUT
            echo "tenant_id=contoso" >> $GITHUB_OUTPUT
          fi

      - name: Check for infrastructure changes
        id: check-changes
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ] && [ "${{ github.event.inputs.force_deploy }}" == "true" ]; then
            echo "should_deploy=true" >> $GITHUB_OUTPUT
            echo "Force deployment requested"
          elif [ "${{ github.event_name }}" == "pull_request" ]; then
            echo "should_deploy=false" >> $GITHUB_OUTPUT
            echo "Pull request - validation only"
          else
            # Check if there are changes in silo/infra directory
            if git diff --name-only HEAD~1 HEAD | grep -q "^silo/infra/"; then
              echo "should_deploy=true" >> $GITHUB_OUTPUT
              echo "Infrastructure changes detected"
            else
              echo "should_deploy=false" >> $GITHUB_OUTPUT
              echo "No infrastructure changes detected"
            fi
          fi

  validate-bicep:
    runs-on: ubuntu-latest
    needs: detect-environment
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Validate Bicep templates
        working-directory: ./silo/infra
        run: |
          echo "Validating Bicep templates..."
          
          # Find all .bicep files and validate them
          for bicep_file in $(find . -name "*.bicep" -type f); do
            echo "Validating $bicep_file"
            az bicep build --file "$bicep_file" --stdout > /dev/null
            if [ $? -eq 0 ]; then
              echo "âœ… $bicep_file is valid"
            else
              echo "âŒ $bicep_file validation failed"
              exit 1
            fi
          done

      - name: What-if deployment (dry-run)
        if: needs.detect-environment.outputs.should_deploy == 'true' || github.event_name == 'pull_request'
        working-directory: ./silo/infra
        run: |
          ENVIRONMENT="${{ needs.detect-environment.outputs.environment }}"
          TENANT_ID="${{ needs.detect-environment.outputs.tenant_id }}"
          RESOURCE_GROUP="rg-fas-silo-${TENANT_ID}-${ENVIRONMENT}"
          
          echo "Running what-if analysis for environment: $ENVIRONMENT, tenant: $TENANT_ID"
          
          # Check if main.bicep exists
          if [ -f "main.bicep" ]; then
            # Check for tenant-specific parameters file first, then environment-specific
            if [ -f "main.parameters.${TENANT_ID}.${ENVIRONMENT}.json" ]; then
              PARAMS_FILE="main.parameters.${TENANT_ID}.${ENVIRONMENT}.json"
            elif [ -f "main.parameters.${ENVIRONMENT}.json" ]; then
              PARAMS_FILE="main.parameters.${ENVIRONMENT}.json"
            elif [ -f "main.parameters.json" ]; then
              PARAMS_FILE="main.parameters.json"
            else
              echo "âŒ No parameters file found"
              exit 1
            fi
            
            echo "Using parameters file: $PARAMS_FILE"
            
            # Create resource group if it doesn't exist
            az group create --name "$RESOURCE_GROUP" --location "Japan East" --only-show-errors || true
            
            # Run what-if analysis
            az deployment group what-if \
              --resource-group "$RESOURCE_GROUP" \
              --template-file "main.bicep" \
              --parameters "@$PARAMS_FILE" tenantId="$TENANT_ID" environment="$ENVIRONMENT" \
              --result-format "FullResourcePayloads"
          else
            echo "âŒ main.bicep not found"
            exit 1
          fi
  deploy-infrastructure:
    runs-on: ubuntu-latest
    needs: [detect-environment, validate-bicep]
    if: needs.detect-environment.outputs.should_deploy == 'true' && github.event_name != 'pull_request'
    environment: 
      name: silo-${{ needs.detect-environment.outputs.tenant_id }}-${{ needs.detect-environment.outputs.environment }}
      url: https://portal.azure.com/#@${{ vars.AZURE_TENANT_ID }}/resource/subscriptions/${{ vars.AZURE_SUBSCRIPTION_ID }}/resourceGroups/rg-fas-silo-${{ needs.detect-environment.outputs.tenant_id }}-${{ needs.detect-environment.outputs.environment }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v2
        with:
          client-id: ${{ vars.AZURE_CLIENT_ID }}
          tenant-id: ${{ vars.AZURE_TENANT_ID }}
          subscription-id: ${{ vars.AZURE_SUBSCRIPTION_ID }}

      - name: Deploy Infrastructure
        working-directory: ./silo/infra
        run: |
          ENVIRONMENT="${{ needs.detect-environment.outputs.environment }}"
          TENANT_ID="${{ needs.detect-environment.outputs.tenant_id }}"
          RESOURCE_GROUP="rg-fas-silo-${TENANT_ID}-${ENVIRONMENT}"
          DEPLOYMENT_NAME="deploy-silo-${TENANT_ID}-${ENVIRONMENT}-$(date +%Y%m%d-%H%M%S)"
          
          echo "Deploying to environment: $ENVIRONMENT"
          echo "Tenant ID: $TENANT_ID"
          echo "Resource Group: $RESOURCE_GROUP"
          echo "Deployment Name: $DEPLOYMENT_NAME"
          
          # Determine parameters file (tenant-specific > environment-specific > default)
          if [ -f "main.parameters.${TENANT_ID}.${ENVIRONMENT}.json" ]; then
            PARAMS_FILE="main.parameters.${TENANT_ID}.${ENVIRONMENT}.json"
          elif [ -f "main.parameters.${ENVIRONMENT}.json" ]; then
            PARAMS_FILE="main.parameters.${ENVIRONMENT}.json"
          elif [ -f "main.parameters.json" ]; then
            PARAMS_FILE="main.parameters.json"
          else
            echo "âŒ No parameters file found"
            exit 1
          fi
          
          echo "Using parameters file: $PARAMS_FILE"
          
          # Create resource group
          echo "Creating resource group..."
          az group create \
            --name "$RESOURCE_GROUP" \
            --location "Japan East" \
            --tags \
              environment="$ENVIRONMENT" \
              architecture="silo" \
              tenantId="$TENANT_ID" \
              deployedBy="github-actions" \
              deploymentId="$DEPLOYMENT_NAME"
          
          # Deploy infrastructure
          echo "Deploying infrastructure..."
          az deployment group create \
            --resource-group "$RESOURCE_GROUP" \
            --template-file "main.bicep" \
            --parameters "@$PARAMS_FILE" tenantId="$TENANT_ID" environment="$ENVIRONMENT" \
            --name "$DEPLOYMENT_NAME" \
            --verbose

      - name: Get deployment outputs
        if: success()
        working-directory: ./silo/infra
        run: |
          ENVIRONMENT="${{ needs.detect-environment.outputs.environment }}"
          TENANT_ID="${{ needs.detect-environment.outputs.tenant_id }}"
          RESOURCE_GROUP="rg-fas-silo-${TENANT_ID}-${ENVIRONMENT}"
          
          echo "Getting deployment outputs..."
          az deployment group show \
            --resource-group "$RESOURCE_GROUP" \
            --name "$(az deployment group list --resource-group "$RESOURCE_GROUP" --query '[0].name' -o tsv)" \
            --query 'properties.outputs' \
            --output table

      - name: Validate deployment
        if: success()
        run: |
          ENVIRONMENT="${{ needs.detect-environment.outputs.environment }}"
          TENANT_ID="${{ needs.detect-environment.outputs.tenant_id }}"
          RESOURCE_GROUP="rg-fas-silo-${TENANT_ID}-${ENVIRONMENT}"
          
          echo "Validating deployment..."
          
          # Check resource group exists
          if az group show --name "$RESOURCE_GROUP" --output none 2>/dev/null; then
            echo "âœ… Resource group exists"
          else
            echo "âŒ Resource group not found"
            exit 1
          fi
          
          # List deployed resources
          echo "Deployed resources:"
          az resource list --resource-group "$RESOURCE_GROUP" --output table

  post-deployment:
    runs-on: ubuntu-latest
    needs: [detect-environment, deploy-infrastructure]
    if: always() && needs.deploy-infrastructure.result != 'skipped'
    steps:
      - name: Post-deployment summary
        run: |
          ENVIRONMENT="${{ needs.detect-environment.outputs.environment }}"
          TENANT_ID="${{ needs.detect-environment.outputs.tenant_id }}"
          
          echo "## Deployment Summary ðŸ“Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: $ENVIRONMENT" >> $GITHUB_STEP_SUMMARY
          echo "- **Tenant**: $TENANT_ID" >> $GITHUB_STEP_SUMMARY
          echo "- **Architecture**: Silo (Tenant-Isolated)" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: ${{ needs.deploy-infrastructure.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Resource Group**: rg-fas-silo-$TENANT_ID-$ENVIRONMENT" >> $GITHUB_STEP_SUMMARY
          echo "- **Deployed by**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.deploy-infrastructure.result }}" == "success" ]; then
            echo "ðŸŽ‰ **Deployment completed successfully!**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY            echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
            echo "- Check the [Azure Portal](https://portal.azure.com/#@${{ vars.AZURE_TENANT_ID }}/resource/subscriptions/${{ vars.AZURE_SUBSCRIPTION_ID }}/resourceGroups/rg-fas-silo-$TENANT_ID-$ENVIRONMENT)" >> $GITHUB_STEP_SUMMARY
            echo "- Verify application deployment status" >> $GITHUB_STEP_SUMMARY
            echo "- Run integration tests" >> $GITHUB_STEP_SUMMARY
            echo "- Configure tenant-specific settings" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Deployment failed!**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Please check the logs and resolve any issues before retrying." >> $GITHUB_STEP_SUMMARY
          fi

      - name: Notify on failure
        if: failure()
        run: |
          echo "ðŸš¨ Silo infrastructure deployment failed for tenant: ${{ needs.detect-environment.outputs.tenant_id }}, environment: ${{ needs.detect-environment.outputs.environment }}"
          echo "Please check the workflow logs for details."
